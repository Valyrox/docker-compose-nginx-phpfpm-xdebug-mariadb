version: "3.9"

networks:
    web-network:
        name: web-network
    traefik-network:
        external: true
        name: traefik-network

services:
    nginx:
        image: "nginx:1.25.2-alpine"
        restart: always
        working_dir: /app
        links:
            - php-fpm
        volumes:
            - ".:/app"
            - "./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf"
        networks:
            - web-network
            - traefik-network
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=traefik-network"
            # Portainer
            - "traefik.http.routers.nginx.rule=HostRegexp(`{domain:.+}`)"
            - "traefik.http.routers.nginx.priority=1"
            - "traefik.http.routers.nginx.service=nginx-svc"
            - "traefik.http.services.nginx-svc.loadbalancer.server.port=80"
            - "traefik.http.routers.nginx.entrypoints=websecure"
            - "traefik.http.routers.nginx.tls=true"
            - "traefik.http.routers.nginx.tls.certresolver=letsencrypt"

    php-fpm:
        build: docker/php-fpm
        restart: always
        working_dir: /app
        links:
            - mariadb
        volumes:
            - ".:/app"
            - "./docker/php-fpm/php-overrides.ini:/usr/local/etc/php/conf.d/php-overrides.ini"
        networks:
            - web-network

    mariadb:
        image: "mariadb:11.1.2"
        restart: always
        working_dir: /app
        volumes:
            - ".:/app"
            - "./docker/mariadb/data:/var/lib/mysql"
            - "./docker/mariadb/logs:/var/log/mysql"
            - "./docker/mariadb/conf:/etc/mysql"
        networks:
            - web-network
        environment:
            MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
            MARIADB_DATABASE: "${MARIADB_DATABASE}"
            MARIADB_USER: "${MARIADB_USER}"
            MARIADB_PASSWORD: "${MARIADB_PASSWORD}"
        ports:
            - "3306:3306"
        healthcheck:
            test: mysqladmin ping -h 127.0.0.1 -u root --password=$$MARIADB_ROOT_PASSWORD
            interval: 5s
            retries: 10

    redis:
        image: "redis:7.2.1-alpine"
        networks:
            - web-network
        environment:
            ALLOW_EMPTY_PASSWORD: "yes"
